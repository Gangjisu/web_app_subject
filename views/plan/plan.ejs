<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Glass OS - Trip Manager (Fixed)</title>
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
<style>
    /* 폰트 및 기본 설정 */
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@200;300;400;500;600&display=swap');
    
    body { 
        margin: 0; 
        padding: 0; 
        overflow: hidden; 
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif; 
        user-select: none; 
        background-color: #000;
    }

    /* 스크롤바 커스텀 */
    .no-scrollbar::-webkit-scrollbar { display: none; }
    .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

    /* 1. 배경 (3D 지도 컨테이너) */
    #map-container {
        position: fixed;
        inset: 0;
        z-index: 0;
        width: 100%;
        height: 100%;
    }
    
    gmp-map-3d {
        width: 100%;
        height: 100%;
        display: block;
    }

    /* 2. Glass 효과 */
    .glass {
        background: rgba(20, 20, 30, 0.45);
        backdrop-filter: blur(30px);
        -webkit-backdrop-filter: blur(30px);
        border: 1px solid rgba(255, 255, 255, 0.08);
        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
    }

    /* 3. OS Window 공통 스타일 */
    .os-window {
        position: absolute;
        border-radius: 20px;
        display: flex;
        flex-direction: column;
        overflow: hidden; 
        /* 기본 트랜지션 (드래그 시 JS로 해제됨) */
        transition: transform 0.2s, opacity 0.2s, width 0.3s, height 0.3s;
        z-index: 10;
        /* 초기 크기 설정 */
    }

    /* Window 1: Settings (좌측) - 높이 문제 수정 */
    #window-settings {
        top: 80px;
        left: 80px;
        width: 400px;
        /* height: auto 대신 명시적 높이 사용으로 잘림 방지 */
        height: 700px; 
        max-height: 85vh;
        /* bottom 속성 제거 (충돌 방지) */
    }

    /* Window 2: Schedule (우측) */
    #window-schedule {
        top: 80px;
        left: 500px; 
        width: 440px;
        height: 700px;
        max-height: 85vh;
        opacity: 0;
        transform: scale(0.95);
        pointer-events: none;
        display: none;
    }

    /* 활성 윈도우 스타일 */
    .os-window.active-window { 
        z-index: 50; 
        border-color: rgba(255,255,255,0.3);
        box-shadow: 0 30px 60px -10px rgba(0, 0, 0, 0.6);
    }
    
    .os-window.minimized {
        opacity: 0 !important;
        transform: scale(0.5) translateY(500px) !important;
        pointer-events: none;
    }
    
    .os-window.maximized {
        /* Theater Mode */
        width: 90vw !important;
        height: 90vh !important;
        top: 5vh !important;
        left: 5vw !important;
        border-radius: 24px !important;
        transform: none !important;
        z-index: 100 !important;
    }

    /* 드래그 중일 때 클래스 (JS에서 추가) */
    .os-window.is-dragging {
        transition: none !important; /* 모든 애니메이션 즉시 정지 */
        cursor: grabbing;
    }
    
    .window-header {
        height: 56px;
        background: linear-gradient(to bottom, rgba(255,255,255,0.05), rgba(255,255,255,0.01));
        border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        display: flex;
        align-items: center;
        padding: 0 24px;
        cursor: grab;
        flex-shrink: 0;
        user-select: none;
    }
    .window-header:active { cursor: grabbing; }

    .traffic-lights { display: flex; gap: 8px; }
    .traffic-light { 
        width: 13px; height: 13px; border-radius: 50%; 
        position: relative; cursor: pointer; display: flex; align-items: center; justify-content: center;
        transition: transform 0.1s;
    }
    .traffic-light:hover { transform: scale(1.1); }
    .close-btn { background: #ff5f56; border: 1px solid #e0443e; }
    .min-btn { background: #ffbd2e; border: 1px solid #dea123; }
    .max-btn { background: #27c93f; border: 1px solid #1aab29; }

    /* 위젯 스타일 */
    .desktop-widget {
        position: fixed;
        top: 60px;
        right: 60px;
        width: 320px;
        background: transparent;
        z-index: 5;
        display: flex;
        flex-direction: column;
        gap: 20px;
        transition: opacity 0.4s ease, transform 0.4s ease;
    }
    .desktop-widget.hidden-widget { opacity: 0; transform: translateX(50px); pointer-events: none; }
    .widget-card {
        padding: 24px;
        border-radius: 24px;
        background: linear-gradient(135deg, rgba(255,255,255,0.05) 0%, rgba(255,255,255,0) 100%);
        border: 1px solid rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(8px);
    }

    /* Dock */
    .dock-wrapper {
        position: fixed;
        bottom: 30px;
        left: 0; right: 0;
        display: flex; justify-content: center;
        z-index: 100;
    }
    .dock {
        display: flex;
        align-items: center;
        gap: 16px;
        padding: 16px 20px;
        border-radius: 28px;
        background: rgba(20, 20, 20, 0.6);
        backdrop-filter: blur(30px);
        border: 1px solid rgba(255, 255, 255, 0.15);
        box-shadow: 0 20px 40px rgba(0,0,0,0.5);
    }
    .dock-item {
        width: 56px; height: 56px;
        border-radius: 18px;
        background: rgba(255,255,255,0.08);
        display: flex; align-items: center; justify-content: center;
        font-size: 24px; color: white;
        cursor: pointer;
        position: relative;
        transition: all 0.2s cubic-bezier(0.2, 0.8, 0.2, 1);
    }
    .dock-item:hover { transform: scale(1.15) translateY(-10px); background: rgba(255,255,255,0.2); }
    .dock-item.active::after {
        content: ''; position: absolute; bottom: -8px; width: 5px; height: 5px;
        background: white; border-radius: 50%; box-shadow: 0 0 10px rgba(255,255,255,0.5);
    }
    
    .glass-input {
        width: 100%;
        background: rgba(255,255,255,0.05);
        border: 1px solid rgba(255,255,255,0.1);
        border-radius: 14px;
        padding: 14px 18px;
        color: white;
        font-size: 15px;
        outline: none;
        transition: all 0.2s;
    }
    .glass-input:focus { background: rgba(255,255,255,0.1); border-color: rgba(255,255,255,0.3); }

    /* Schedule Specific Styles */
    .dashed-line {
        background-image: linear-gradient(to right, rgba(255,255,255,0.2) 50%, rgba(255,255,255,0) 0%);
        background-position: bottom;
        background-size: 8px 1px;
        background-repeat: repeat-x;
        height: 1px;
    }
    .font-numeric { font-variant-numeric: tabular-nums; }
    .dragging { opacity: 0.4 !important; transform: scale(0.98); }
    .glass-panel {
        background: rgba(255, 255, 255, 0.05);
        backdrop-filter: blur(12px);
        border: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    /* View Switching */
    .view-section {
        /* 절대 위치로 겹쳐두어 레이아웃 흔들림 방지 가능하나, flex 구조 유지 */
        transition: opacity 0.3s ease, transform 0.3s ease;

        height: 100%;
        display: flex;
        flex-direction: column;
    }
    .hidden-view {
        display: none !important;
        opacity: 0;
        transform: translateX(20px);
    }
</style>
</head>
<body class="text-white selection:bg-emerald-500/30">

    <!-- 1. 3D Map Background -->
    <div id="map-container"></div>

    <!-- 2. Desktop Widget -->
    <div id="desktop-widget" class="desktop-widget">
        <div class="widget-card">
            <div class="flex items-center justify-between mb-4">
                <div>
                    <h2 class="text-4xl font-light tracking-tighter">24°</h2>
                    <p class="text-white/60 text-sm mt-1">Tokyo, Japan</p>
                </div>
                <i class="fa-solid fa-cloud-sun text-5xl text-amber-300 drop-shadow-[0_0_15px_rgba(252,211,77,0.6)]"></i>
            </div>
            <div class="space-y-3">
                <div class="flex justify-between text-xs text-white/50 font-medium">
                    <span>HUMIDITY</span>
                    <span>42%</span>
                </div>
                <div class="w-full bg-white/10 h-1.5 mt-2 rounded-full overflow-hidden">
                    <div class="bg-gradient-to-r from-amber-300 to-orange-400 w-2/3 h-full"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- 3. Window 1: Settings & Planning -->
    <div id="window-settings" class="os-window glass active-window" onmousedown="bringToFront('window-settings')">
        <div class="window-header">
            <div class="traffic-lights group">
                <div class="traffic-light close-btn" onclick="windowControl('settings', 'close')"></div>
                <div class="traffic-light min-btn" onclick="windowControl('settings', 'minimize')"></div>
                <div class="traffic-light max-btn" onclick="windowControl('settings', 'maximize')"></div>
            </div>
            <div class="flex-1 text-center text-sm font-medium text-white/60 pointer-events-none flex justify-center items-center gap-2">
                <i class="fa-solid fa-earth-americas text-emerald-400"></i>
                <span id="settings-title">Trip Settings</span>
            </div>
            <div class="w-14"></div>
        </div>

        <div class="flex-1 overflow-hidden relative bg-transparent flex flex-col">
            
            <!-- VIEW 1: Initial Settings (높이 문제 해결) -->
            <div id="view-settings" class="view-section p-8 overflow-y-auto no-scrollbar gap-8">
                <!-- Destination -->
                <div class="flex-shrink-0">
                    <label class="text-xs text-white/40 ml-1 mb-2 block font-semibold tracking-wider">DESTINATION</label>
                    <div class="relative group">
                        <div class="w-full glass-input flex items-center justify-between bg-white/10 border-white/20 py-4">
                            <span class="font-medium text-white tracking-wide text-lg"><i class="fa-solid fa-location-dot mr-3 text-rose-400"></i>Tokyo, Japan</span>
                            <i class="fa-solid fa-lock text-white/20 text-xs"></i>
                        </div>
                    </div>
                </div>

                <!-- Date -->
                <div class="flex-shrink-0">
                    <div class="flex items-center justify-between mb-2">
                         <label class="text-xs text-white/40 ml-1 font-semibold tracking-wider">DATE</label>
                         <span id="duration-badge" class="text-[10px] bg-emerald-500/20 text-emerald-400 px-2 py-0.5 rounded border border-emerald-500/30 hidden font-bold">0 DAYS</span>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div class="bg-white/5 border border-white/10 rounded-2xl p-4 hover:bg-white/10 transition-colors">
                            <span class="text-[10px] text-white/40 uppercase block mb-1 font-bold">Start</span>
                            <input type="date" id="start-date" class="bg-transparent text-white text-base outline-none w-full p-0 border-none font-medium">
                        </div>
                        <div class="bg-white/5 border border-white/10 rounded-2xl p-4 hover:bg-white/10 transition-colors">
                            <span class="text-[10px] text-white/40 uppercase block mb-1 font-bold">End</span>
                            <input type="date" id="end-date" class="bg-transparent text-white text-base outline-none w-full p-0 border-none font-medium">
                        </div>
                    </div>
                </div>

                <!-- Theme (충분한 높이 확보) -->
                <div class="flex-1 flex flex-col min-h-[200px]">
                     <label class="text-xs text-white/40 ml-1 mb-2 font-semibold tracking-wider">TRIP THEME</label>
                     <textarea id="trip-theme" class="w-full h-full glass-input resize-none p-5 leading-relaxed placeholder:text-white/20 text-base" placeholder="Describe your dream trip style...&#10;e.g. I want a healing trip with onsen, local food tour, and historical sites. No rushing."></textarea>
                </div>

                <!-- Next Button -->
                <button id="btn-to-plan" onclick="goToPlanning()" disabled class="w-full py-5 rounded-2xl bg-white/5 text-white/30 font-semibold text-lg shadow-lg transition-all flex items-center justify-center gap-3 group mb-2 cursor-not-allowed border border-white/5 flex-shrink-0">
                    <span>Next Step</span>
                    <i class="fa-solid fa-arrow-right group-hover:translate-x-1 transition-transform"></i>
                </button>
            </div>

            <!-- VIEW 2: Planning -->
            <div id="view-planning" class="view-section hidden-view p-8 overflow-y-auto no-scrollbar gap-8">
                <!-- Header -->
                <div class="flex items-center gap-4 mb-2 flex-shrink-0">
                    <button onclick="backToSettings()" class="w-10 h-10 rounded-full bg-white/5 hover:bg-white/10 border border-white/10 flex items-center justify-center text-white/70 transition">
                        <i class="fa-solid fa-chevron-left"></i>
                    </button>
                    <div>
                        <h2 class="text-xl font-medium text-white">Planning</h2>
                        <p class="text-xs text-white/40">Search and add spots</p>
                    </div>
                </div>

                <!-- Search -->
                <div class="flex-shrink-0">
                    <label class="text-xs text-white/40 ml-1 mb-2 block font-semibold tracking-wider">SEARCH PLACE</label>
                    <div class="relative">
                        <i class="fa-solid fa-magnifying-glass absolute left-4 top-1/2 -translate-y-1/2 text-white/30"></i>
                        <input type="text" id="place_search" class="glass-input pl-12 py-4" placeholder="Search a spot..." autocomplete="off">
                        <div id="autocomplete_results" class="absolute top-full left-0 right-0 mt-2 bg-[#1e1e28]/95 border border-white/10 rounded-xl overflow-hidden z-50 hidden max-h-[250px] overflow-y-auto shadow-2xl backdrop-blur-xl"></div>
                    </div>
                </div>

                <!-- Requirements -->
                <div class="flex-1 flex flex-col min-h-[150px]">
                     <label class="text-xs text-white/40 ml-1 mb-2 font-semibold tracking-wider">REQUIREMENTS</label>
                     <textarea id="plan-req" class="w-full h-full glass-input resize-none p-5 leading-relaxed placeholder:text-white/20 text-base" placeholder="Notes for this location..."></textarea>
                </div>

                <!-- Actions -->
                <div id="action-buttons" class="flex flex-col gap-4 opacity-50 pointer-events-none transition-opacity duration-300 flex-shrink-0">
                    <p class="text-[10px] text-center text-white/30 uppercase tracking-widest mb-1 font-bold">ADD TO SCHEDULE</p>
                    <button onclick="addToPlan('ai')" class="w-full py-4 rounded-2xl bg-gradient-to-r from-indigo-600 to-violet-600 text-white font-bold text-lg shadow-lg hover:shadow-indigo-500/30 hover:scale-[1.02] active:scale-[0.98] transition-all flex items-center justify-center gap-3 border border-white/10">
                        <i class="fa-solid fa-wand-magic-sparkles text-indigo-200"></i>
                        <span>Generate Smart Plan</span>
                    </button>
                    <button onclick="addToPlan('custom')" class="w-full py-4 rounded-2xl bg-white/5 border border-white/10 text-white font-medium hover:bg-white/10 transition-all flex items-center justify-center gap-3">
                        <i class="fa-solid fa-plus text-white/50"></i>
                        <span>Add Custom Spot</span>
                    </button>
                </div>
            </div>

        </div>
    </div>

    <!-- 4. Window 2: Schedule (Edit Button Removed) -->
    <div id="window-schedule" class="os-window glass" onmousedown="bringToFront('window-schedule')">
        <div class="window-header">
            <div class="traffic-lights group">
                <div class="traffic-light close-btn" onclick="windowControl('schedule', 'close')"></div>
                <div class="traffic-light min-btn" onclick="windowControl('schedule', 'minimize')"></div>
                <div class="traffic-light max-btn" onclick="windowControl('schedule', 'maximize')"></div>
            </div>
            <div class="flex-1 text-center text-sm font-medium text-white/60 pointer-events-none flex justify-center items-center gap-2">
                <i class="fa-solid fa-list-check text-sky-400"></i>
                <span>Current Plan</span>
            </div>
            <!-- [Edit Button Deleted] -->
            <div class="w-14"></div> 
        </div>

        <div class="flex-1 overflow-hidden flex flex-col relative bg-transparent p-0">
             <header class="pt-8 px-8 flex-shrink-0">
                <div class="flex items-center justify-between mb-2">
                    <h1 id="schedule-title" class="text-4xl font-thin tracking-tight text-white/95">Tokyo Trip</h1>
                    <span id="schedule-status" class="px-3 py-1 rounded-full bg-emerald-500/10 text-[10px] font-bold tracking-widest uppercase border border-emerald-500/20 text-emerald-400 backdrop-blur-md">Draft</span>
                </div>
                <p id="schedule-subtitle" class="text-white/40 text-sm font-light">Drag items to optimize route.</p>
            </header>

            <main id="schedule-container" class="flex-1 overflow-y-auto no-scrollbar relative px-8 pb-8 pt-6">
                <div id="schedule-list" class="relative z-10 space-y-0 min-h-[500px]"></div>
            </main>
        </div>
    </div>

    <!-- 5. Dock -->
    <div class="dock-wrapper">
        <div class="dock">
            <div class="dock-item">
                <i class="fa-solid fa-face-smile text-sky-400"></i>
            </div>
            <div class="dock-item active" id="dock-settings" onclick="windowControl('settings', 'dock')">
                <i class="fa-solid fa-earth-americas text-emerald-400"></i>
            </div>
            <div class="dock-item" id="dock-schedule" onclick="windowControl('schedule', 'dock')">
                <i class="fa-solid fa-list-check text-sky-400"></i>
            </div>
            <div class="dock-item active" id="dock-widget" onclick="toggleWidgets()">
                <i class="fa-solid fa-table-cells-large text-amber-300"></i>
            </div>
        </div>
    </div>

    <script>
      (g=>{var h,a,k,p="The Google Maps JavaScript API",c="google",l="importLibrary",q="__ib__",m=document,b=window;b=b[c]||(b[c]={});var d=b.maps||(b.maps={}),r=new Set,e=new URLSearchParams,u=()=>h||(h=new Promise(async(f,n)=>{await (a=m.createElement("script"));e.set("libraries",[...r]+"");for(k in g)e.set(k.replace(/[A-Z]/g,t=>"_"+t[0].toLowerCase()),g[k]);e.set("callback",c+".maps."+q);a.src=`https://maps.${c}apis.com/maps/api/js?`+e;d[q]=f;a.onerror=()=>h=n(Error(p+" could not load."));a.nonce=m.querySelector("script[nonce]")?.nonce||"";m.head.append(a)}));d[l]?console.warn(p+" only loads once. Ignoring:",g):d[l]=(f,...n)=>r.add(f)&&u().then(()=>d[l](f,...n))})({
        key: "<%= googleMapsApiKey %>", v: "beta",
      });
    </script>

    <script type="module">
        /* =========================================
           1. Window Management (Stabilized)
           ========================================= */
        const windows = {
            settings: { el: document.getElementById('window-settings'), dock: document.getElementById('dock-settings'), state: 'open' },
            schedule: { el: document.getElementById('window-schedule'), dock: document.getElementById('dock-schedule'), state: 'closed' }
        };

        window.windowControl = (id, action) => {
            const win = windows[id];
            if (!win) return;

            if (action === 'close') {
                win.el.style.opacity = '0';
                win.el.style.pointerEvents = 'none';
                win.el.style.transform = 'scale(0.9)';
                win.dock.classList.remove('active');
                win.state = 'closed';
                setTimeout(() => { if(win.state === 'closed') win.el.style.display = 'none'; }, 200);
            } 
            else if (action === 'minimize') {
                win.el.classList.add('minimized');
                win.state = 'minimized';
            } 
            else if (action === 'maximize') {
                win.el.classList.toggle('maximized');
            }
            else if (action === 'dock') {
                if (win.state === 'closed') {
                    win.el.style.display = 'flex';
                    void win.el.offsetWidth; 
                    win.el.style.opacity = '1';
                    win.el.style.transform = 'scale(1)';
                    win.el.style.pointerEvents = 'auto';
                    win.el.classList.remove('minimized');
                    win.dock.classList.add('active');
                    win.state = 'open';
                    bringToFront(`window-${id}`);
                    if(id === 'schedule') { setTimeout(() => { renderSchedule(); updateLinePosition(); }, 100); }
                } else if (win.state === 'minimized') {
                    win.el.classList.remove('minimized');
                    win.state = 'open';
                    bringToFront(`window-${id}`);
                } else {
                    win.el.classList.add('minimized');
                    win.state = 'minimized';
                }
            }
        };

        window.bringToFront = (elementId) => {
            document.querySelectorAll('.os-window').forEach(w => w.classList.remove('active-window'));
            document.getElementById(elementId).classList.add('active-window');
        };

        // --- Draggable Logic (Highly Optimized) ---
        let isDragging = false;
        let startX, startY, initialLeft, initialTop, dragTarget = null;
        let rafId = null;

        document.querySelectorAll('.window-header').forEach(header => {
            header.addEventListener('mousedown', (e) => {
                if (e.target.closest('.traffic-lights') || e.target.tagName === 'BUTTON') return;
                
                dragTarget = header.parentElement;
                if (dragTarget.classList.contains('maximized')) return;

                isDragging = true;
                startX = e.clientX;
                startY = e.clientY;
                
                const rect = dragTarget.getBoundingClientRect();
                initialLeft = rect.left;
                initialTop = rect.top;
                
                // [중요] 드래그 시작 시 애니메이션 완전 제거 클래스 추가
                dragTarget.classList.add('is-dragging');
                bringToFront(dragTarget.id);
            });
        });

        document.addEventListener('mousemove', (e) => {
            if (!isDragging || !dragTarget) return;
            
            // RAF를 사용하여 프레임 드랍 방지
            if (rafId) cancelAnimationFrame(rafId);
            rafId = requestAnimationFrame(() => {
                const dx = e.clientX - startX;
                const dy = e.clientY - startY;
                dragTarget.style.left = `${initialLeft + dx}px`;
                dragTarget.style.top = `${initialTop + dy}px`;
            });
        });

        document.addEventListener('mouseup', () => {
            if (isDragging && dragTarget) {
                // [중요] 드래그 종료 시 클래스 제거하여 트랜지션 복구
                dragTarget.classList.remove('is-dragging');
            }
            isDragging = false;
            dragTarget = null;
            if (rafId) cancelAnimationFrame(rafId);
        });

        // --- View Switching Logic ---
        const viewSettings = document.getElementById('view-settings');
        const viewPlanning = document.getElementById('view-planning');
        const btnToPlan = document.getElementById('btn-to-plan');
        const startDate = document.getElementById('start-date');
        const endDate = document.getElementById('end-date');
        const themeInput = document.getElementById('trip-theme');

        function checkSettingsValidity() {
            if (startDate.value && endDate.value && themeInput.value.trim().length > 0) {
                btnToPlan.disabled = false;
                btnToPlan.classList.remove('bg-white/5', 'text-white/30', 'cursor-not-allowed', 'border-white/5');
                btnToPlan.classList.add('bg-gradient-to-r', 'from-emerald-600', 'to-teal-600', 'text-white', 'shadow-emerald-500/20', 'border-transparent');
            } else {
                btnToPlan.disabled = true;
                btnToPlan.classList.add('bg-white/5', 'text-white/30', 'cursor-not-allowed', 'border-white/5');
                btnToPlan.classList.remove('bg-gradient-to-r', 'from-emerald-600', 'to-teal-600', 'text-white', 'shadow-emerald-500/20', 'border-transparent');
            }
        }
        
        startDate.addEventListener('change', checkSettingsValidity);
        endDate.addEventListener('change', checkSettingsValidity);
        themeInput.addEventListener('input', checkSettingsValidity);

        window.goToPlanning = () => {
            viewSettings.classList.add('hidden-view');
            // Wait for fade out
            setTimeout(() => {
                viewSettings.style.display = 'none'; // Completely hide
                viewPlanning.style.display = 'flex'; // Enable flex layout
                
                // Trigger reflow
                void viewPlanning.offsetWidth;
                
                viewPlanning.classList.remove('hidden-view'); // Fade in
            }, 300);
            
            if(windows.schedule.state === 'closed') windowControl('schedule', 'dock');
        };

        window.backToSettings = () => {
            viewPlanning.classList.add('hidden-view');
            setTimeout(() => {
                viewPlanning.style.display = 'none';
                viewSettings.style.display = 'flex';
                void viewSettings.offsetWidth;
                viewSettings.classList.remove('hidden-view');
            }, 300);
        };

        /* =========================================
           2. Plan Logic: Search & Add
           ========================================= */
        let currentSelectedPlace = null;
        
        const searchInput = document.getElementById('place_search');
        const resultsDiv = document.getElementById('autocomplete_results');
        const actionButtons = document.getElementById('action-buttons');

        searchInput.addEventListener('input', async (e) => {
            const val = e.target.value;
            if (val.length < 2) {
                resultsDiv.classList.add('hidden');
                return;
            }
            const { AutocompleteService } = await google.maps.importLibrary("places");
            const service = new AutocompleteService();
            service.getPlacePredictions({ input: val, componentRestrictions: { country: 'jp' } }, (predictions, status) => {
                if (status === google.maps.places.PlacesServiceStatus.OK && predictions) {
                    resultsDiv.innerHTML = '';
                    resultsDiv.classList.remove('hidden');
                    predictions.forEach(p => {
                        const div = document.createElement('div');
                        div.className = 'p-4 hover:bg-white/10 cursor-pointer border-b border-white/5 text-sm text-white/90 flex items-center gap-3 transition-colors';
                        div.innerHTML = `<i class="fa-solid fa-location-dot text-white/40"></i> <span>${p.description}</span>`;
                        div.onclick = () => selectPlace(p);
                        resultsDiv.appendChild(div);
                    });
                }
            });
        });

        async function selectPlace(place) {
            searchInput.value = place.description;
            resultsDiv.classList.add('hidden');
            currentSelectedPlace = place;
            const { PlacesService } = await google.maps.importLibrary("places");
            const placesService = new PlacesService(document.createElement('div'));
            placesService.getDetails({ placeId: place.place_id }, (detail, status) => {
                if (status === google.maps.places.PlacesServiceStatus.OK) {
                    currentSelectedPlace.details = detail;
                    if(map) {
                         map.flyCameraTo({
                            endCamera: {
                                center: { lat: detail.geometry.location.lat(), lng: detail.geometry.location.lng(), altitude: 0 },
                                range: 1000, tilt: 0, heading: 0
                            }, durationMillis: 2000
                        });
                    }
                }
            });
            actionButtons.classList.remove('opacity-50', 'pointer-events-none');
        }

        window.addToPlan = (type) => {
            if (!currentSelectedPlace || !currentSelectedPlace.details) return;
            const name = currentSelectedPlace.structured_formatting.main_text;
            const category = type === 'ai' ? 'AI Recommended' : 'Custom Spot';
            const lat = currentSelectedPlace.details.geometry.location.lat();
            const lng = currentSelectedPlace.details.geometry.location.lng();
            const newItem = {
                id: Date.now().toString(),
                name: name, duration: 2, category: category, coords: { lat: lat, lng: lng }
            };
            scheduleState.activities.push(newItem);
            renderSchedule();
            searchInput.value = '';
            actionButtons.classList.add('opacity-50', 'pointer-events-none');
            currentSelectedPlace = null;
        };

        /* =========================================
           4. Schedule Logic & Render
           ========================================= */
        const Icons = {
            plane: `<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2 12h20"/><path d="m13 2 9 10-9 10"/><path d="M5.5 12h-3.5"/></svg>`,
            check: `<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22c5.523 0 10-4.477 10-10S17.523 2 12 2 2 6.477 2 12s4.477 10 10 10z"/><path d="m9 12 2 2 4-4"/></svg>`,
            mapPin: `<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z"/><circle cx="12" cy="10" r="3"/></svg>`,
            grip: `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="9" cy="12" r="1"/><circle cx="9" cy="5" r="1"/><circle cx="9" cy="19" r="1"/><circle cx="15" cy="12" r="1"/><circle cx="15" cy="5" r="1"/><circle cx="15" cy="19" r="1"/></svg>`,
        };

        const MAX_HOURS = 10;
        let scheduleState = {
            activities: [
                { id: '1', name: 'National Museum', duration: 3, category: 'art', coords: { lat: 35.7189, lng: 139.7757 } },
                { id: '2', name: 'Central Park', duration: 2, category: 'nature', coords: { lat: 35.7140, lng: 139.7741 } },
                { id: '3', name: 'City Temple', duration: 2, category: 'culture', coords: { lat: 35.7147, lng: 139.7967 } },
                { id: '4', name: 'Skytree View', duration: 3, category: 'view', coords: { lat: 35.7100, lng: 139.8107 } },
            ],
            draggedItemIndex: null,
            gapDistances: {}
        };

        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371; 
            const dLat = (lat2 - lat1) * (Math.PI/180);
            const dLon = (lon2 - lon1) * (Math.PI/180);
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) + Math.cos(lat1 * (Math.PI/180)) * Math.cos(lat2 * (Math.PI/180)) * Math.sin(dLon/2) * Math.sin(dLon/2); 
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)); 
            return R * c * 1.3; 
        }

        function createStartNode() {
            return `<div class="flex w-full group relative mb-6 pt-4">
                <div class="w-14 flex-shrink-0 relative flex justify-center items-center">
                    <div id="start-dot" class="w-3 h-3 rounded-full bg-emerald-500/20 border-emerald-500/30 border shadow-[0_0_10px_rgba(0,0,0,0.5)] z-10 flex items-center justify-center">
                        <div class="w-1 h-1 rounded-full bg-emerald-400"></div>
                    </div>
                </div>
                <div class="flex-1 pr-1">
                    <div class="px-5 py-4 rounded-2xl bg-white/5 border border-white/5 backdrop-blur-sm flex items-center justify-between w-full shadow-sm hover:bg-white/10 transition-colors">
                        <div class="flex items-center gap-4">
                            <div class="p-2 rounded-xl bg-emerald-500/20 text-emerald-400">${Icons.plane}</div>
                            <div class="flex flex-col"><span class="text-sm font-bold text-white/90">Incheon</span><span class="text-[10px] text-white/40 uppercase tracking-wide">Departure</span></div>
                        </div>
                        <span class="text-xs text-white/30 font-mono">10:00 AM</span>
                    </div>
                </div>
            </div>`;
        }
        function createEndNode() {
            return `
            <br>
            <div class="flex w-full group relative mb-4 mt-12">
                <div class="w-14 flex-shrink-0 relative flex justify-center items-center">
                    <div id="end-dot" class="w-3 h-3 rounded-full bg-rose-500/20 border-rose-500/30 border shadow-[0_0_10px_rgba(0,0,0,0.5)] z-10 flex items-center justify-center">
                        <div class="w-1 h-1 rounded-full bg-rose-400"></div>
                    </div>
                </div>
                <div class="flex-1 pr-1">
                    <div class="px-5 py-4 rounded-2xl bg-white/5 border border-white/5 backdrop-blur-sm flex items-center justify-between w-full shadow-sm hover:bg-white/10 transition-colors">
                         <div class="flex items-center gap-4">
                            <div class="p-2 rounded-xl bg-rose-500/20 text-rose-400">${Icons.check}</div>
                            <div class="flex flex-col"><span class="text-sm font-bold text-white/90">Incheon</span><span class="text-[10px] text-white/40 uppercase tracking-wide">Arrival</span></div>
                        </div>
                        <span class="text-xs text-white/30 font-mono">08:00 PM</span>
                    </div>
                </div>
            </div>`;
        }
        function createActivityItem(item, index) {
            return `<div class="activity-item flex w-full relative group transition-all duration-300 ease-out mb-2" draggable="true" data-index="${index}">
                <div class="w-14 flex-shrink-0 relative">
                    <div class="absolute left-[50%] top-[-14px] bottom-[50%] w-[50%] border-l border-b border-slate-600/50 rounded-bl-xl pointer-events-none"></div>
                    <div class="absolute right-[-4px] top-1/2 -translate-y-1/2 w-2 h-2 rounded-full bg-slate-800 border border-white/30 z-10 group-hover:bg-sky-400 group-hover:border-sky-400 transition-colors"></div>
                </div>
                <div class="flex-1 pr-1 min-w-0">
                    <div class="glass-panel relative p-4 pl-5 rounded-2xl flex items-center gap-4 cursor-grab active:cursor-grabbing transform transition-all group-hover:translate-x-1 hover:bg-white/10 hover:shadow-lg">
                        <div class="w-10 h-10 rounded-xl bg-white/5 flex items-center justify-center text-white/40 group-hover:text-white/90 transition-colors">${Icons.mapPin}</div>
                        <div class="flex-1 min-w-0">
                            <h3 class="text-base font-medium text-white/95 truncate pointer-events-none">${item.name}</h3>
                            <span class="text-[11px] text-white/30 uppercase tracking-wider pointer-events-none">${item.category}</span>
                        </div>
                        <div class="pr-3 border-l border-white/5 pl-4 flex flex-col items-center min-w-[3.5rem] pointer-events-none">
                            <span class="text-lg font-light text-white/80">${item.duration}<span class="text-[10px] ml-0.5 opacity-50">h</span></span>
                        </div>
                        <div class="absolute right-3 top-1/2 -translate-y-1/2 opacity-0 group-hover:opacity-30 text-white transition-opacity">${Icons.grip}</div>
                    </div>
                </div>
            </div>`;
        }

        function renderSchedule() {
            const listContainer = document.getElementById('schedule-list');
            if(!listContainer) return;
            let html = `<div id="timeline-guide" class="absolute left-7 w-px bg-slate-600/50 z-0 transition-all duration-300 rounded-full"></div>`;
            html += createStartNode();

            let days = []; let currentDayItems = []; let currentHours = 0; let dayCount = 1;
            scheduleState.activities.forEach(item => {
                if(currentHours + item.duration > MAX_HOURS) {
                    days.push({ day: dayCount, items: currentDayItems, hours: currentHours });
                    dayCount++; currentDayItems = []; currentHours = 0;
                }
                currentDayItems.push(item); currentHours += item.duration;
            });
            if(currentDayItems.length > 0) days.push({ day: dayCount, items: currentDayItems, hours: currentHours });

            let globalIndex = 0; let connectors = [];
            days.forEach(day => {
                const percent = (day.hours / MAX_HOURS) * 100;
                const color = percent >= 100 ? 'bg-rose-400' : 'bg-sky-400';
                html += `<div class="flex w-full h-14 items-center relative mt-10 mb-4">
                    <div class="w-14 flex-shrink-0 relative flex justify-center items-center">
                        <div class="w-5 h-5 rounded-full bg-slate-900 border-2 border-sky-400/50 shadow z-10 flex items-center justify-center">
                            <div class="w-2 h-2 rounded-full bg-sky-400"></div>
                        </div>
                    </div>
                    <div class="flex-1 pr-1 flex items-center justify-between">
                        <h2 class="text-xl font-bold text-white tracking-wide ml-1 drop-shadow-md">Day ${day.day}</h2>
                        <div class="flex items-center gap-3 bg-black/20 px-4 py-1.5 rounded-full border border-white/5 backdrop-blur-md">
                            <div class="w-24 h-1.5 bg-white/10 rounded-full overflow-hidden">
                                <div class="h-full transition-all duration-500 ease-out ${color}" style="width: ${Math.min(percent, 100)}%"></div>
                            </div>
                            <span class="text-xs text-sky-200/60 font-mono">${day.hours}h</span>
                        </div>
                    </div>
                </div>`;

                day.items.forEach((item, idx) => {
                    const realIndex = scheduleState.activities.findIndex(a => a.id === item.id);
                    html += createActivityItem(item, realIndex);
                    if (idx < day.items.length - 1) {
                        const nextItem = day.items[idx + 1];
                        const dist = calculateDistance(item.coords.lat, item.coords.lng, nextItem.coords.lat, nextItem.coords.lng);
                        const cId = `gap-${globalIndex}`;
                        html += `<div class="flex w-full items-center justify-end pl-14 pr-1 py-2 opacity-90 h-10 relative">
                            <div class="flex-1 dashed-line mr-3 opacity-30"></div>
                            <div id="connector-${cId}" class="connector-badge relative flex items-center justify-center h-7 bg-slate-800/60 border border-white/10 rounded-full shadow-lg backdrop-blur-md overflow-hidden transition-all duration-500 ease-out" style="width: 70px;">
                                <div class="absolute left-0 top-0 bottom-0 bg-sky-500/10 w-full"></div>
                                <span class="text-xs text-sky-200 font-mono font-bold tracking-wider font-numeric relative z-10">0m</span>
                            </div>
                            <div class="flex-1 dashed-line ml-3 opacity-30"></div>
                        </div>`;
                        connectors.push({ id: cId, val: dist, index: globalIndex });
                        globalIndex++;
                    }
                });
            });

            html += createEndNode();
            listContainer.innerHTML = html;

            connectors.forEach(c => {
                const el = document.getElementById(`connector-${c.id}`);
                const span = el.querySelector('span');
                const startDist = scheduleState.gapDistances[c.index] || 0;
                const targetDist = c.val;
                if(el) {
                    const minW = 70; const maxW = 240;
                    const startW = Math.min(maxW, minW + (startDist * 12));
                    const targetW = Math.min(maxW, minW + (targetDist * 12));
                    el.style.width = `${startW}px`;
                    requestAnimationFrame(() => el.style.width = `${targetW}px`);
                }
                animateValue(span, startDist, targetDist, 600);
                scheduleState.gapDistances[c.index] = targetDist;
            });

            attachDragEvents();
            requestAnimationFrame(updateLinePosition);
        }

        function animateValue(obj, start, end, duration) {
            if(!obj) return;
            let startTimestamp = null;
            const step = (timestamp) => {
                if (!startTimestamp) startTimestamp = timestamp;
                const progress = Math.min((timestamp - startTimestamp) / duration, 1);
                const currentVal = start + (end - start) * (1 - Math.pow(1 - progress, 3));
                if (currentVal < 1) obj.innerHTML = `${Math.round(currentVal * 1000)}m`;
                else obj.innerHTML = `${currentVal.toFixed(1)}km`;
                if (progress < 1) window.requestAnimationFrame(step);
            };
            window.requestAnimationFrame(step);
        }

        function attachDragEvents() {
            const items = document.querySelectorAll('.activity-item');
            items.forEach(item => {
                item.addEventListener('dragstart', handleDragStart);
                item.addEventListener('dragenter', handleDragEnter);
                item.addEventListener('dragend', handleDragEnd);
                item.addEventListener('dragover', e => e.preventDefault());
            });
        }
        function handleDragStart(e) {
            scheduleState.draggedItemIndex = Number(this.dataset.index);
            this.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
        }
        function handleDragEnter(e) {
            e.preventDefault();
            const targetIndex = Number(this.dataset.index);
            if (scheduleState.draggedItemIndex === null || scheduleState.draggedItemIndex === targetIndex) return;
            const newItems = [...scheduleState.activities];
            const item = newItems.splice(scheduleState.draggedItemIndex, 1)[0];
            newItems.splice(targetIndex, 0, item);
            scheduleState.activities = newItems;
            scheduleState.draggedItemIndex = targetIndex;
            renderSchedule();
        }
        function handleDragEnd(e) {
            this.classList.remove('dragging');
            scheduleState.draggedItemIndex = null;
            renderSchedule();
        }
        function updateLinePosition() {
            const startDot = document.getElementById('start-dot');
            const endDot = document.getElementById('end-dot');
            const guideLine = document.getElementById('timeline-guide');
            const container = document.getElementById('schedule-container'); 
            if (startDot && endDot && guideLine && container && container.offsetParent !== null) {
                const containerRect = container.getBoundingClientRect();
                const startRect = startDot.getBoundingClientRect();
                const endRect = endDot.getBoundingClientRect();
                const top = (startRect.top + startRect.height/2) - containerRect.top + container.scrollTop;
                const bottom = (endRect.top + endRect.height/2) - containerRect.top + container.scrollTop;
                guideLine.style.top = `${top}px`;
                guideLine.style.height = `${bottom - top}px`;
            }
        }

        // Listeners
        window.addEventListener('resize', updateLinePosition);
        document.getElementById('schedule-container').addEventListener('scroll', updateLinePosition);

        // Map Init
        let map;
        async function initMap() {
            await google.maps.importLibrary("maps3d");
            map = document.createElement('gmp-map-3d');
            map.setAttribute('center', '35.6895,139.6917'); 
            map.setAttribute('tilt', '0');
            map.setAttribute('range', '2000');
            map.setAttribute('heading', '30');
            map.setAttribute('mode', 'hybrid');
            document.getElementById('map-container').append(map);
        }
        initMap();
        
        // Widget Toggle
        let isWidgetsVisible = true;
        window.toggleWidgets = () => {
            isWidgetsVisible = !isWidgetsVisible;
            const widget = document.getElementById('desktop-widget');
            const icon = document.getElementById('dock-widget');
            if (isWidgetsVisible) {
                widget.classList.remove('hidden-widget');
                icon.classList.add('active');
            } else {
                widget.classList.add('hidden-widget');
                icon.classList.remove('active');
            }
        };

        // Initialize Dates
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('start-date').value = today;
        document.getElementById('end-date').value = today;

    </script>
</body>
</html>