<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Glass OS - Trip Manager (Complete Fixed)</title>
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
<link rel="stylesheet" href="/css/plan.css">
</head>
<body class="text-white selection:bg-emerald-500/30">

    <div id="map-container"></div>

    <!-- Desktop Widget -->
    <div id="desktop-widget" class="desktop-widget">
        <div id="dest-info-widget" class="widget-card group cursor-default">
            <div class="h-36 relative overflow-hidden">
                <img id="dest-image" src="https://images.unsplash.com/photo-1540959733332-eab4deabeeaf?q=80&w=1000&auto=format&fit=crop" class="w-full h-full object-cover transition-transform duration-700 group-hover:scale-110">
                <div class="absolute inset-0 bg-gradient-to-t from-[#1e1e28] to-transparent"></div>
                <div class="absolute bottom-4 left-5">
                    <h2 id="dest-name" class="text-2xl font-bold tracking-tight text-white">Tokyo, Japan</h2>
                    <p class="text-[10px] text-white/60 uppercase tracking-widest font-medium mt-1">CURRENT DESTINATION</p>
                </div>
            </div>
            <div class="p-5">
                <div class="flex justify-between items-center text-xs text-white/50 border-b border-white/5 pb-4 mb-4">
                    <span class="flex items-center"><i class="fa-solid fa-plane-arrival mr-2"></i>Incheon</span>
                    <span class="flex items-center"><i class="fa-regular fa-calendar mr-2"></i><span id="widget-date-range">Nov 28 - Nov 30</span></span>
                </div>
                <div class="flex items-center gap-3">
                    <span class="relative flex h-3 w-3">
                      <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-emerald-400 opacity-75"></span>
                      <span class="relative inline-flex rounded-full h-3 w-3 bg-emerald-500"></span>
                    </span>
                    <span class="text-xs text-emerald-400 font-medium tracking-wide">Trip Active</span>
                </div>
            </div>
        </div>

        <div id="preview-widget" class="widget-card hidden-view transform translate-x-10 transition-all duration-300 w-[360px]">
            <div class="relative h-48">
                <img id="preview-image" src="" class="absolute inset-0 w-full h-full object-cover opacity-0 transition-opacity duration-500">
                <div class="absolute inset-0 bg-gradient-to-t from-[#1e1e28] via-transparent to-transparent"></div>
                <div class="absolute top-3 right-3 z-10 flex gap-2">
                    <div class="px-2 py-1 bg-black/50 backdrop-blur-md rounded-md text-[10px] font-bold border border-white/10 text-white flex items-center gap-1">
                        <i class="fa-solid fa-wand-magic-sparkles text-indigo-400"></i>
                        <span id="preview-source-badge">AI PICK</span>
                    </div>
                </div>
                <div class="absolute bottom-3 left-5 right-5">
                    <h3 id="preview-title" class="text-2xl font-bold text-white leading-tight drop-shadow-lg">Loading...</h3>
                    <div class="flex items-center gap-2 mt-1">
                        <div id="preview-rating" class="text-amber-400 text-xs flex gap-0.5"></div>
                        <span id="preview-category" class="text-[10px] text-white/70 font-medium px-2 py-0.5 bg-white/10 rounded-full backdrop-blur-sm border border-white/5">Thinking</span>
                    </div>
                </div>
            </div>
            <div class="p-5 pt-2">
                <div class="flex items-center justify-between mb-3 text-xs text-white/50 border-b border-white/5 pb-3">
                    <span class="flex items-center gap-1.5"><i class="fa-regular fa-clock"></i> <span id="preview-duration">--</span></span>
                    <span id="route-context" class="flex items-center gap-1.5 text-emerald-400 hidden"><i class="fa-solid fa-person-walking"></i> <span>+15 min</span></span>
                </div>
                
                <div class="mb-4">
                    <div class="flex items-start gap-2 mb-2">
                        <i class="fa-solid fa-quote-left text-indigo-500/50 text-xs mt-1"></i>
                        <p id="preview-desc" class="text-sm text-white/80 leading-relaxed font-light">Analyzing...</p>
                    </div>
                    <div id="preview-keywords" class="flex flex-wrap gap-2 mt-3"></div>
                </div>

                <div class="grid grid-cols-2 gap-2 mt-4">
                    <button id="btn-confirm-add" onclick="confirmAddToPlan()" class="col-span-2 py-3.5 rounded-xl bg-white text-black font-bold text-sm hover:bg-gray-200 transition-colors flex items-center justify-center gap-2 disabled:opacity-50 shadow-lg shadow-white/5" disabled>
                        <i class="fa-solid fa-plus"></i> Add to Schedule
                    </button>
                    <button onclick="rejectPreview()" class="py-2.5 rounded-xl bg-white/5 hover:bg-white/10 text-white/70 text-xs font-medium transition-colors border border-white/10">Dismiss</button>
                    <button onclick="regeneratePreview()" class="py-2.5 rounded-xl bg-white/5 hover:bg-white/10 text-white/70 text-xs font-medium transition-colors border border-white/10"><i class="fa-solid fa-rotate-right mr-1"></i> Retry</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Window 1: Settings & Planning -->
    <div id="window-settings" class="os-window glass active-window" onmousedown="bringToFront('window-settings')">
        <div class="window-header">
            <div class="traffic-lights group">
                <div class="traffic-light close-btn" onclick="windowControl('settings', 'close')"></div>
                <div class="traffic-light min-btn" onclick="windowControl('settings', 'minimize')"></div>
                <div class="traffic-light max-btn" onclick="windowControl('settings', 'maximize')"></div>
            </div>
            <div class="flex-1 text-center text-sm font-medium text-white/60 pointer-events-none flex justify-center items-center gap-2">
                <i class="fa-solid fa-earth-americas text-emerald-400"></i>
                <span id="settings-title">Trip Settings</span>
            </div>
            <div class="w-14"></div>
        </div>

        <div class="flex-1 overflow-hidden relative bg-transparent flex flex-col">
            <div id="view-settings" class="view-section p-8 overflow-y-auto no-scrollbar gap-8">
                <div class="flex-shrink-0">
                    <label class="text-xs text-white/40 ml-1 mb-2 block font-semibold tracking-wider">DESTINATION</label>
                    <div class="relative group">
                        <div class="w-full glass-input flex items-center justify-between bg-white/10 border-white/20 py-4">
                            <span class="font-medium text-white tracking-wide text-lg"><i class="fa-solid fa-location-dot mr-3 text-rose-400"></i>Tokyo, Japan</span>
                            <i class="fa-solid fa-lock text-white/20 text-xs"></i>
                        </div>
                    </div>
                </div>
                <div class="flex-shrink-0">
                    <div class="flex items-center justify-between mb-2">
                         <label class="text-xs text-white/40 ml-1 font-semibold tracking-wider">DATE</label>
                         <span id="duration-badge" class="text-[10px] bg-emerald-500/20 text-emerald-400 px-2 py-0.5 rounded border border-emerald-500/30 hidden font-bold">0 DAYS</span>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div class="bg-white/5 border border-white/10 rounded-2xl p-4 hover:bg-white/10 transition-colors">
                            <span class="text-[10px] text-white/40 uppercase block mb-1 font-bold">Start</span>
                            <input type="date" id="start-date" class="bg-transparent text-white text-base outline-none w-full p-0 border-none font-medium">
                        </div>
                        <div class="bg-white/5 border border-white/10 rounded-2xl p-4 hover:bg-white/10 transition-colors">
                            <span class="text-[10px] text-white/40 uppercase block mb-1 font-bold">End</span>
                            <input type="date" id="end-date" class="bg-transparent text-white text-base outline-none w-full p-0 border-none font-medium">
                        </div>
                    </div>
                </div>
                <div class="flex-1 flex flex-col min-h-[200px]">
                     <label class="text-xs text-white/40 ml-1 mb-2 font-semibold tracking-wider">TRIP THEME</label>
                     <textarea id="trip-theme" class="w-full h-full glass-input resize-none p-5 leading-relaxed placeholder:text-white/20 text-base" placeholder="e.g. Healing, Food tour..."></textarea>
                </div>
                <button id="btn-to-plan" onclick="goToPlanning()" disabled class="w-full py-5 rounded-2xl bg-white/5 text-white/30 font-semibold text-lg shadow-lg transition-all flex items-center justify-center gap-3 group mb-2 cursor-not-allowed border border-white/5 flex-shrink-0">
                    <span>Next Step</span>
                    <i class="fa-solid fa-arrow-right group-hover:translate-x-1 transition-transform"></i>
                </button>
            </div>

            <div id="view-planning" class="view-section hidden-view p-8 overflow-y-auto no-scrollbar gap-6">
                <div class="flex items-center gap-4 mb-2 flex-shrink-0">
                    <button onclick="backToSettings()" class="w-10 h-10 rounded-full bg-white/5 hover:bg-white/10 border border-white/10 flex items-center justify-center text-white/70 transition">
                        <i class="fa-solid fa-chevron-left"></i>
                    </button>
                    <div>
                        <h2 class="text-xl font-medium text-white">Planning</h2>
                        <p class="text-xs text-white/40">Search and add spots</p>
                    </div>
                </div>
                <div class="flex gap-3 mb-2 p-1 bg-white/5 rounded-2xl border border-white/5">
                    <button id="mode-smart" onclick="setPlanMode('smart')" class="tab-btn active"><i class="fa-solid fa-wand-magic-sparkles text-lg text-emerald-400"></i><span>AI Smart</span></button>
                    <button id="mode-custom" onclick="setPlanMode('custom')" class="tab-btn inactive"><i class="fa-solid fa-pen-to-square text-lg text-sky-400"></i><span>Custom</span></button>
                </div>
                <div class="flex-shrink-0">
                    <label class="text-xs text-white/40 ml-1 mb-2 block font-semibold tracking-wider">SEARCH PLACE</label>
                    <div class="relative">
                        <i class="fa-solid fa-magnifying-glass absolute left-4 top-1/2 -translate-y-1/2 text-white/30"></i>
                        <input type="text" id="place_search" class="glass-input pl-12 py-4" placeholder="Search a spot..." autocomplete="off">
                        <div id="autocomplete_results" class="absolute top-full left-0 right-0 mt-2 bg-[#1e1e28]/95 border border-white/10 rounded-xl overflow-hidden z-50 hidden max-h-[250px] overflow-y-auto shadow-2xl backdrop-blur-xl"></div>
                    </div>
                </div>
                <div id="panel-smart" class="flex-1 flex flex-col gap-6">
                    <div class="flex-1 flex flex-col min-h-[150px]">
                         <label class="text-xs text-white/40 ml-1 mb-2 font-semibold tracking-wider">AI REQUIREMENTS</label>
                         <textarea id="plan-req" class="w-full h-full glass-input resize-none p-5 leading-relaxed placeholder:text-white/20 text-base" placeholder="Ask AI to plan activity..."></textarea>
                    </div>
                    <button id="btn-smart-gen" onclick="triggerPreview('ai')" class="w-full py-4 rounded-2xl bg-gradient-to-r from-indigo-600 to-violet-600 text-white font-bold text-lg shadow-lg hover:shadow-indigo-500/30 transition-all flex items-center justify-center gap-2 border border-white/10 opacity-50 cursor-not-allowed" disabled>
                        <i class="fa-solid fa-wand-magic-sparkles text-indigo-200"></i>
                        <span>Create Smart Plan</span>
                    </button>
                </div>
                <div id="panel-custom" class="flex-1 flex flex-col gap-6 hidden">
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="text-xs text-white/40 ml-1 mb-2 block font-semibold">CATEGORY</label>
                            <input type="text" id="custom-category" class="glass-input h-14" placeholder="e.g. Food">
                        </div>
                        <div>
                            <label class="text-xs text-white/40 ml-1 mb-2 block font-semibold">DURATION (H)</label>
                            <input type="number" id="custom-duration" class="glass-input h-14" value="2" min="0.5" step="0.5">
                        </div>
                    </div>
                    <div class="flex-1">
                        <label class="text-xs text-white/40 ml-1 mb-2 block font-semibold">ACTIVITY NAME</label>
                        <input type="text" id="custom-name" class="glass-input h-14" placeholder="e.g. Lunch at..." >
                    </div>
                    <button id="btn-custom-add" onclick="triggerPreview('custom')" class="mt-auto w-full py-4 rounded-2xl bg-white/10 border border-white/10 text-white font-medium hover:bg-white/20 transition-all flex items-center justify-center gap-2 opacity-50 cursor-not-allowed" disabled>
                        <i class="fa-solid fa-plus"></i>
                        <span>Preview Plan</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Window 2: Schedule -->
    <div id="window-schedule" class="os-window glass" onmousedown="bringToFront('window-schedule')">
        <div class="window-header">
            <div class="traffic-lights group">
                <div class="traffic-light close-btn" onclick="windowControl('schedule', 'close')"></div>
                <div class="traffic-light min-btn" onclick="windowControl('schedule', 'minimize')"></div>
                <div class="traffic-light max-btn" onclick="windowControl('schedule', 'maximize')"></div>
            </div>
            <div class="flex-1 text-center text-sm font-medium text-white/60 pointer-events-none flex justify-center items-center gap-2">
                <i class="fa-solid fa-list-check text-sky-400"></i>
                <span>Current Plan</span>
            </div>
            <div class="w-14"></div>
        </div>

        <div class="flex-1 overflow-hidden flex flex-col relative bg-transparent p-0">
             <header class="pt-8 px-8 flex-shrink-0">
                <div class="flex items-center justify-between mb-2">
                    <h1 id="schedule-title" class="text-4xl font-thin tracking-tight text-white/95">Tokyo Trip</h1>
                    <span id="schedule-status" class="px-3 py-1 rounded-full bg-emerald-500/10 text-[10px] font-bold tracking-widest uppercase border border-emerald-500/20 text-emerald-400 backdrop-blur-md">Draft</span>
                </div>
                <p id="schedule-subtitle" class="text-white/40 text-sm font-light">Drag items to optimize route.</p>
            </header>

            <main id="schedule-container" class="flex-1 overflow-y-auto no-scrollbar relative px-8 pb-8 pt-6">
                <div id="schedule-list" class="relative z-10 space-y-0 min-h-[500px]"></div>
            </main>
        </div>
    </div>

    <!-- Dock -->
    <div class="dock-wrapper">
        <div class="dock">
            <div class="dock-item active" id="dock-settings" onclick="windowControl('settings', 'dock')">
                <i class="fa-solid fa-earth-americas text-emerald-400"></i>
            </div>
            <div class="dock-item" id="dock-schedule" onclick="windowControl('schedule', 'dock')">
                <i class="fa-solid fa-list-check text-sky-400"></i>
            </div>
            <div class="dock-item active" id="dock-widget" onclick="toggleWidgets()">
                <i class="fa-solid fa-table-cells-large text-amber-300"></i>
            </div>
        </div>
    </div>

    <script>
      (g=>{var h,a,k,p="The Google Maps JavaScript API",c="google",l="importLibrary",q="__ib__",m=document,b=window;b=b[c]||(b[c]={});var d=b.maps||(b.maps={}),r=new Set,e=new URLSearchParams,u=()=>h||(h=new Promise(async(f,n)=>{await (a=m.createElement("script"));e.set("libraries",[...r]+"");for(k in g)e.set(k.replace(/[A-Z]/g,t=>"_"+t[0].toLowerCase()),g[k]);e.set("callback",c+".maps."+q);a.src=`https://maps.${c}apis.com/maps/api/js?`+e;d[q]=f;a.onerror=()=>h=n(Error(p+" could not load."));a.nonce=m.querySelector("script[nonce]")?.nonce||"";m.head.append(a)}));d[l]?console.warn(p+" only loads once. Ignoring:",g):d[l]=(f,...n)=>r.add(f)&&u().then(()=>d[l](f,...n))})({
        key: "<%= googleMapsApiKey %>", v: "beta",
      });
    </script>

    <script>
        const GOOGLE_MAPS_API_KEY = "<%= googleMapsApiKey %>";
    </script>
    <script type="module" src="/javascripts/plan/app.js"></script>
</body>
</html>
